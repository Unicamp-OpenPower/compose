#!/bin/bash

set -ex

TARGET=dist/docker-compose-$(uname -s)-$(uname -m)
VENV=/code/.tox/py36

ARCH=$(uname -m)

mkdir -p `pwd`/dist
chmod 777 `pwd`/dist

if [[ "$ARCH" == "ppc64le" ]]; then
    # build pyinstaller from source
    PREVDIR=$(pwd)
    cd $VENV/bin/
    git clone https://github.com/pyinstaller/pyinstaller.git pyinstaller-src
    cd pyinstaller-src && git checkout tags/v3.2.1
    cd bootloader
    # python ./waf distclean all
    # python ./waf distclean all --no-lsb
    python waf all configure --no-lsb build install
    # cp -a ../PyInstaller/bootloader/Linux-64bit/run ../../pyinstaller
    # cp -a build/release/run ../../pyinstaller
    cd $PREVDIR
    $VENV/bin/pip install -q -e $VENV/bin/pyinstaller-src
else
    # install pyinstaller from pip
    $VENV/bin/pip install -q -r requirements-build.txt
fi
./script/build/write-git-sha
ls -l $VENV/bin/
su -c "$VENV/bin/pyinstaller docker-compose.spec" user
mv dist/docker-compose $TARGET
$TARGET version
